<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - TK Kutilang</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --light-bg: #f4f7fc;
        --sidebar-bg: #13294b; /* Biru Tua dari web utama */
        --sidebar-link: rgba(255, 255, 255, 0.8);
        --sidebar-link-hover: #fff;
        --sidebar-active-bg: #ff6b35; /* Oranye dari web utama */
        --font-main: "Roboto", sans-serif;
        --font-heading: "Fredoka", sans-serif;
      }
      body {
        background-color: var(--light-bg);
        font-family: var(--font-main);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: var(--font-heading);
      }
      .wrapper {
        display: flex;
        width: 100%;
        align-items: stretch;
      }
      #sidebar {
        min-width: 250px;
        max-width: 250px;
        background: var(--sidebar-bg);
        color: #fff;
        transition: all 0.3s;
        position: fixed;
        height: 100%;
      }
      #sidebar.active {
        margin-left: -250px;
      }
      #sidebar .sidebar-header {
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      #sidebar ul.components {
        padding: 20px 0;
      }
      #sidebar ul li a {
        padding: 15px 20px;
        font-size: 1.1em;
        display: block;
        color: var(--sidebar-link);
        transition: all 0.2s;
      }
      #sidebar ul li a:hover {
        color: var(--sidebar-link-hover);
        background: rgba(255, 255, 255, 0.1);
        text-decoration: none;
      }
      #sidebar ul li.active > a {
        color: #fff;
        background: var(--sidebar-active-bg);
      }
      #content {
        width: calc(100% - 250px);
        padding: 2rem;
        min-height: 100vh;
        transition: all 0.3s;
        margin-left: 250px;
      }
      .card {
        border: none;
        border-radius: 0.75rem;
      }
      .card-stats {
        border-left: 5px solid;
        transition: all 0.3s ease;
      }
      .card-stats:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
      }
      .card-stats .bi {
        font-size: 2.5rem;
        opacity: 0.3;
      }
      .card-stats-total {
        border-color: #0d6efd;
      }
      .card-stats-monthly {
        border-color: #198754;
      }
      .card-stats-male {
        border-color: #0dcaf0;
      }
      .card-stats-female {
        border-color: #ff6b35;
      }
      .table-hover tbody tr:hover {
        background-color: #fff3cd;
      }
      .action-btn {
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .action-btn:hover {
        opacity: 1;
      }
      .toast-container {
        z-index: 1090;
      }
      .hidden {
        display: none;
      }
      .login-container {
        max-width: 400px;
        margin: 100px auto;
      }
      .badge-Laki-laki {
        background-color: #0dcaf0;
        color: #000;
      }
      .badge-Perempuan {
        background-color: #e83e8c;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="loginSection">
      <div class="container">
        <div class="login-container">
          <div class="card shadow-lg">
            <div class="card-header text-center bg-primary text-white p-3">
              <h4 class="mb-0">
                <i class="bi bi-person-check-fill"></i> Login Admin
              </h4>
            </div>
            <div class="card-body p-4">
              <form id="loginForm">
                <div class="mb-3">
                  <label for="adminPassword" class="form-label"
                    >Password Admin</label
                  >
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-lock-fill"></i
                    ></span>
                    <input
                      type="password"
                      class="form-control"
                      id="adminPassword"
                      required
                    />
                  </div>
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary fw-bold">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Masuk
                  </button>
                </div>
              </form>
              <div id="loginError" class="alert alert-danger mt-3 hidden">
                Password salah! Silakan coba lagi.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="dashboardSection" class="wrapper hidden">
      <nav id="sidebar">
        <div class="sidebar-header">
          <h3><i class="bi bi-house-heart-fill"></i> TK Kutilang</h3>
        </div>
        <ul class="list-unstyled components">
          <li class="active">
            <a href="#"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
          </li>
          <li>
            <a href="#" id="logoutBtn"
              ><i class="bi bi-box-arrow-left me-2"></i>Logout</a
            >
          </li>
        </ul>
      </nav>

      <div id="content">
        <nav
          class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm"
        >
          <div class="container-fluid">
            <h4 class="mb-0">Dashboard Admin</h4>
            <span class="navbar-text fw-bold">Selamat Datang!</span>
          </div>
        </nav>

        <div class="row">
          <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-stats card-stats-total shadow-sm">
              <div class="card-body">
                <div class="row">
                  <div class="col-8 text-start">
                    <p class="card-title text-muted mb-1">Total Pendaftar</p>
                    <h3 id="totalRegistrations" class="mb-0">0</h3>
                  </div>
                  <div
                    class="col-4 d-flex align-items-center justify-content-end text-primary"
                  >
                    <i class="bi bi-people-fill"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-stats card-stats-monthly shadow-sm">
              <div class="card-body">
                <div class="row">
                  <div class="col-8 text-start">
                    <p class="card-title text-muted mb-1">Bulan Ini</p>
                    <h3 id="monthlyRegistrations" class="mb-0">0</h3>
                  </div>
                  <div
                    class="col-4 d-flex align-items-center justify-content-end text-success"
                  >
                    <i class="bi bi-calendar-check-fill"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-stats card-stats-male shadow-sm">
              <div class="card-body">
                <div class="row">
                  <div class="col-8 text-start">
                    <p class="card-title text-muted mb-1">Laki-Laki</p>
                    <h3 id="maleCount" class="mb-0">0</h3>
                  </div>
                  <div
                    class="col-4 d-flex align-items-center justify-content-end text-info"
                  >
                    <i class="bi bi-gender-male"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-4">
            <div class="card card-stats card-stats-female shadow-sm">
              <div class="card-body">
                <div class="row">
                  <div class="col-8 text-start">
                    <p class="card-title text-muted mb-1">Perempuan</p>
                    <h3 id="femaleCount" class="mb-0">0</h3>
                  </div>
                  <div
                    class="col-4 d-flex align-items-center justify-content-end"
                    style="color: #ff6b35"
                  >
                    <i class="bi bi-gender-female"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div
              class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"
            >
              <h5 class="mb-0">Manajemen Data Pendaftar</h5>
              <button
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#createModal"
              >
                <i class="bi bi-plus-circle me-2"></i>Tambah Data
              </button>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Cari Data</label
                ><input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="Nama, email..."
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Filter Gender</label
                ><select class="form-select" id="genderFilter">
                  <option value="">Semua Gender</option>
                  <option value="Laki-laki">Laki-laki</option>
                  <option value="Perempuan">Perempuan</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Filter Bulan</label
                ><select class="form-select" id="monthFilter">
                  <option value="">Semua Bulan</option>
                </select>
              </div>
              <div class="col-md-2 d-grid align-content-end">
                <button class="btn btn-success" id="exportBtn">
                  <i class="bi bi-download me-1"></i>Export
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th>No</th>
                    <th>Tanggal</th>
                    <th>Nama Anak</th>
                    <th>Gender</th>
                    <th>Nama Orang Tua</th>
                    <th>Email</th>
                    <th>Status Pembayaran</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
              </table>
            </div>
            <div id="loadingIndicator" class="text-center p-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Memuat data...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="liveToast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto" id="toastTitle"></strong
          ><button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
          ></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
      </div>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-plus-fill me-2"></i>Tambah Data Pendaftar
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="createForm">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Informasi Anak</h6>
                  <div class="mb-3">
                    <label class="form-label">Nama Lengkap Anak</label
                    ><input
                      type="text"
                      class="form-control"
                      id="create_nama_lengkap_anak"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Tanggal Lahir</label
                    ><input
                      type="date"
                      class="form-control"
                      id="create_tanggal_lahir"
                      required
                    />
                  </div>
                  <div>
                    <label class="form-label">Jenis Kelamin</label
                    ><select
                      class="form-select"
                      id="create_jenis_kelamin"
                      required
                    >
                      <option value="">Pilih...</option>
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Informasi Orang Tua</h6>
                  <div class="mb-3">
                    <label class="form-label">Nama Orang Tua</label
                    ><input
                      type="text"
                      class="form-control"
                      id="create_nama_orang_tua"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label
                    ><input
                      type="email"
                      class="form-control"
                      id="create_email"
                      required
                    />
                  </div>
                  <div>
                    <label class="form-label">No. Telepon</label
                    ><input
                      type="tel"
                      class="form-control"
                      id="create_nomor_telepon"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Alamat Lengkap</label
                ><textarea
                  class="form-control"
                  id="create_alamat"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div>
                <label class="form-label">Informasi Tambahan</label
                ><textarea
                  class="form-control"
                  id="create_informasi_tambahan"
                  rows="2"
                ></textarea>
              </div>
              <div class="mt-3">
                <label class="form-label fw-bold">Status Pembayaran</label>
                <select
                  class="form-select"
                  id="create_status_pembayaran"
                  required
                >
                  <option value="Belum Dicek">Belum Dicek</option>
                  <option value="Menunggu Pembayaran">
                    Menunggu Pembayaran
                  </option>
                  <option value="Lunas">Lunas</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal</button
              ><button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>Simpan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square me-2"></i>Edit Data Pendaftaran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="editForm">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6>Informasi Anak</h6>
                  <div class="mb-3">
                    <label class="form-label">Nama Lengkap Anak</label
                    ><input
                      type="text"
                      class="form-control"
                      id="edit_nama_lengkap_anak"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Tanggal Lahir</label
                    ><input
                      type="date"
                      class="form-control"
                      id="edit_tanggal_lahir"
                      required
                    />
                  </div>
                  <div>
                    <label class="form-label">Jenis Kelamin</label
                    ><select
                      class="form-select"
                      id="edit_jenis_kelamin"
                      required
                    >
                      <option value="">Pilih...</option>
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <h6>Informasi Orang Tua</h6>
                  <div class="mb-3">
                    <label class="form-label">Nama Orang Tua</label
                    ><input
                      type="text"
                      class="form-control"
                      id="edit_nama_orang_tua"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label
                    ><input
                      type="email"
                      class="form-control"
                      id="edit_email"
                      required
                    />
                  </div>
                  <div>
                    <label class="form-label">No. Telepon</label
                    ><input
                      type="tel"
                      class="form-control"
                      id="edit_nomor_telepon"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Alamat Lengkap</label
                ><textarea
                  class="form-control"
                  id="edit_alamat"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div>
                <label class="form-label">Informasi Tambahan</label
                ><textarea
                  class="form-control"
                  id="edit_informasi_tambahan"
                  rows="2"
                ></textarea>
              </div>
              <div class="mt-3">
                <label class="form-label fw-bold">Status Pembayaran</label>
                <select
                  class="form-select"
                  id="edit_status_pembayaran"
                  required
                >
                  <option value="Belum Dicek">Belum Dicek</option>
                  <option value="Menunggu Pembayaran">
                    Menunggu Pembayaran
                  </option>
                  <option value="Lunas">Lunas</option>
                </select>
              </div>
              <input type="hidden" id="editRowIndex" />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal</button
              ><button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>Simpan Perubahan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-lines-fill me-2"></i>Detail Pendaftaran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="detailModalBody"></div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE_URL = "/kutilang/api/"; // Path absolut dari root web server
      const API_GET_URL = API_BASE_URL + "ambil-data.php";
      const API_MANAGE_URL = API_BASE_URL + "kelola-data.php";
      const API_EXPORT_URL = API_BASE_URL + "export-csv.php";
      const ADMIN_PASSWORD = "admin123";

      let allData = [],
        filteredData = [];
      const liveToast = new bootstrap.Toast(
        document.getElementById("liveToast")
      );

      function showToast(title, message, type = "success") {
        const toastHeader = document.querySelector("#liveToast .toast-header");
        document.getElementById("toastTitle").textContent = title;
        document.getElementById("toastBody").textContent = message;
        toastHeader.className = "toast-header text-white";
        toastHeader.classList.add(
          type === "success" ? "bg-success" : "bg-danger"
        );
        liveToast.show();
      }

      document.getElementById("loginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        if (document.getElementById("adminPassword").value === ADMIN_PASSWORD) {
          document.getElementById("loginSection").classList.add("hidden");
          document
            .getElementById("dashboardSection")
            .classList.remove("hidden");
          loadDashboard();
        } else {
          document.getElementById("loginError").classList.remove("hidden");
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        document.getElementById("dashboardSection").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("adminPassword").value = "";
      });

      async function loadDashboard() {
        document.getElementById("loadingIndicator").style.display = "block";
        try {
          const response = await fetch(API_GET_URL);
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const result = await response.json();
          if (result.status === "success") {
            allData = result.data;
            updateStats();
            populateFilters();
            applyFilters(); // Apply filter to render table
          } else {
            throw new Error(result.message);
          }
        } catch (error) {
          showToast("Error", "Gagal memuat data: " + error.message, "error");
        } finally {
          document.getElementById("loadingIndicator").style.display = "none";
        }
      }

      function updateStats() {
        const total = allData.length;
        const currentMonth = new Date().getMonth();
        const monthlyCount = allData.filter(
          (i) => new Date(i.waktu_pendaftaran).getMonth() === currentMonth
        ).length;
        document.getElementById("totalRegistrations").textContent = total;
        document.getElementById("monthlyRegistrations").textContent =
          monthlyCount;
        document.getElementById("maleCount").textContent = allData.filter(
          (i) => i.jenis_kelamin === "Laki-laki"
        ).length;
        document.getElementById("femaleCount").textContent = allData.filter(
          (i) => i.jenis_kelamin === "Perempuan"
        ).length;
      }

      function populateFilters() {
        const monthFilter = document.getElementById("monthFilter");
        monthFilter.innerHTML = '<option value="">Semua Bulan</option>';
        const months = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        const uniqueMonths = [
          ...new Set(allData.map((i) => i.waktu_pendaftaran.substring(0, 7))),
        ]
          .sort()
          .reverse();
        uniqueMonths.forEach((ym) => {
          const [year, month] = ym.split("-");
          const option = document.createElement("option");
          option.value = ym;
          option.textContent = `${months[parseInt(month) - 1]} ${year}`;
          monthFilter.appendChild(option);
        });
      }

      function renderTable() {
        const tbody = document.getElementById("dataTableBody");
        tbody.innerHTML = "";
        if (filteredData.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="8" class="text-center p-4">Data tidak ditemukan.</td></tr>';
          return;
        }
        filteredData.forEach((item, index) => {
          const row = document.createElement("tr");
          const badgeClass = `badge-${item.jenis_kelamin.replace(/\s+/g, "-")}`;

          let statusBadge = "";
          switch (item.status_pembayaran) {
            case "Lunas":
              statusBadge = '<span class="badge bg-success">Lunas</span>';
              break;
            case "Menunggu Pembayaran":
              statusBadge =
                '<span class="badge bg-warning text-dark">Menunggu Pembayaran</span>';
              break;
            default:
              statusBadge =
                '<span class="badge bg-secondary">Belum Dicek</span>';
          }

          // Pastikan urutan <td> dan properti item.namakolom sudah sesuai
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${new Date(item.waktu_pendaftaran).toLocaleDateString(
              "id-ID"
            )}</td>
            <td><strong>${item.nama_lengkap_anak}</strong></td>
            <td><span class="badge ${badgeClass}">${
            item.jenis_kelamin
          }</span></td>
            <td>${item.nama_orang_tua}</td>
            <td>${item.email}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-outline-info action-btn" onclick="showDetail(${
                  item.rowIndex
                })" title="Lihat Detail"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-warning action-btn" onclick="editData(${
                  item.rowIndex
                })" title="Edit Data"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteData(${
                  item.rowIndex
                },'${
            item.nama_lengkap_anak
          }')" title="Hapus Data"><i class="bi bi-trash"></i></button>
            </td>
        `;
          tbody.appendChild(row);
        });
      }

      function showDetail(rowIndex) {
        const item = allData.find((d) => d.rowIndex == rowIndex);
        if (!item) return;
        const modalBody = document.getElementById("detailModalBody");
        modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Anak</h6>
                <dl class="row">
                    <dt class="col-sm-5">Nama:</dt><dd class="col-sm-7">${
                      item.nama_lengkap_anak
                    }</dd>
                    <dt class="col-sm-5">Tgl Lahir:</dt><dd class="col-sm-7">${new Date(
                      item.tanggal_lahir
                    ).toLocaleDateString("id-ID")}</dd>
                    <dt class="col-sm-5">Gender:</dt><dd class="col-sm-7">${
                      item.jenis_kelamin
                    }</dd>
                </dl>
            </div>
            <div class="col-md-6">
                <h6>Orang Tua</h6>
                <dl class="row">
                    <dt class="col-sm-4">Nama:</dt><dd class="col-sm-8">${
                      item.nama_orang_tua
                    }</dd>
                    <dt class="col-sm-4">Email:</dt><dd class="col-sm-8">${
                      item.email
                    }</dd>
                    <dt class="col-sm-4">Telepon:</dt><dd class="col-sm-8">${
                      item.nomor_telepon
                    }</dd>
                </dl>
            </div>
        </div>
        <hr><h6>Alamat</h6><p>${item.alamat}</p>
        <h6>Info Tambahan</h6><p>${item.informasi_tambahan || "-"}</p>
        <small class="text-muted">Didaftarkan: ${new Date(
          item.waktu_pendaftaran
        ).toLocaleString("id-ID")}</small>
    `;
        new bootstrap.Modal(document.getElementById("detailModal")).show();
      }

      function editData(rowIndex) {
        const item = allData.find((d) => d.rowIndex == rowIndex);
        if (!item) return; // Jika data tidak ditemukan, hentikan

        // Mengisi form dengan data dari objek 'item' yang key-nya sudah Bahasa Indonesia
        document.getElementById("edit_nama_lengkap_anak").value =
          item.nama_lengkap_anak || "";
        document.getElementById("edit_tanggal_lahir").value =
          item.tanggal_lahir || "";
        document.getElementById("edit_jenis_kelamin").value =
          item.jenis_kelamin || "";
        document.getElementById("edit_nama_orang_tua").value =
          item.nama_orang_tua || "";
        document.getElementById("edit_email").value = item.email || "";
        document.getElementById("edit_nomor_telepon").value =
          item.nomor_telepon || "";
        document.getElementById("edit_alamat").value = item.alamat || "";
        document.getElementById("edit_informasi_tambahan").value =
          item.informasi_tambahan || "";
        document.getElementById("edit_status_pembayaran").value =
          item.status_pembayaran || "Belum Dicek";

        document.getElementById("editRowIndex").value = item.rowIndex;
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      async function deleteData(rowIndex, childName) {
        if (confirm(`Yakin ingin menghapus data "${childName}"?`)) {
          try {
            const response = await fetch(
              `${API_MANAGE_URL}?action=deleteRow&rowIndex=${rowIndex}`
            );
            const result = await response.json();
            if (result.status !== "success") throw new Error(result.message);
            showToast(
              "Sukses",
              `Data ${childName} berhasil dihapus.`,
              "success"
            );
            loadDashboard();
          } catch (error) {
            showToast("Error", "Gagal hapus data: " + error.message, "error");
          }
        }
      }

      document
        .getElementById("createForm")
        .addEventListener("submit", (e) => handleFormSubmit(e));
      document
        .getElementById("editForm")
        .addEventListener("submit", (e) => handleFormSubmit(e));

      async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const isEdit = form.id === "editForm";
        const action = isEdit ? "edit" : "create";
        const modalId = isEdit ? "editModal" : "createModal";
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

        // Membuat objek 'data' dengan key yang konsisten
        const data = {
          nama_lengkap_anak: document.getElementById(
            `${action}_nama_lengkap_anak`
          ).value,
          tanggal_lahir: document.getElementById(`${action}_tanggal_lahir`)
            .value,
          jenis_kelamin: document.getElementById(`${action}_jenis_kelamin`)
            .value,
          nama_orang_tua: document.getElementById(`${action}_nama_orang_tua`)
            .value,
          email: document.getElementById(`${action}_email`).value,
          nomor_telepon: document.getElementById(`${action}_nomor_telepon`)
            .value,
          alamat: document.getElementById(`${action}_alamat`).value,
          informasi_tambahan: document.getElementById(
            `${action}_informasi_tambahan`
          ).value,
          status_pembayaran: document.getElementById(
            `${action}_status_pembayaran`
          ).value,
        };
        try {
          const response = await fetch(API_MANAGE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: action,
              rowIndex: isEdit
                ? document.getElementById("editRowIndex").value
                : undefined,
              data: data,
            }),
          });
          const result = await response.json();
          if (result.status !== "success") throw new Error(result.message);

          bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
          form.reset();
          showToast(
            "Sukses",
            `Data berhasil di${isEdit ? "update" : "tambahkan"}.`,
            "success"
          );
          loadDashboard(); // Muat ulang data untuk melihat perubahan
        } catch (error) {
          showToast("Error", `Gagal menyimpan: ${error.message}`, "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      ["searchInput", "genderFilter", "monthFilter"].forEach((id) => {
        document.getElementById(id).addEventListener("input", applyFilters);
      });

      function applyFilters() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const genderFilter = document.getElementById("genderFilter").value;
        const monthFilter = document.getElementById("monthFilter").value;
        filteredData = allData.filter(
          (item) =>
            (searchTerm === "" ||
              Object.values(item).some((val) =>
                String(val).toLowerCase().includes(searchTerm)
              )) &&
            (genderFilter === "" || item.jenis_kelamin === genderFilter) &&
            (monthFilter === "" ||
              item.waktu_pendaftaran.startsWith(monthFilter))
        );
        renderTable();
      }

      document
        .getElementById("exportBtn")
        .addEventListener(
          "click",
          () => (window.location.href = API_EXPORT_URL)
        );
    </script>
  </body>
</html>
