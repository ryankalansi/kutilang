<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - TK</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <style>
      .navbar-brand {
        font-weight: bold;
      }
      .card-stats {
        border-left: 4px solid #007bff;
      }
      .table-container {
        max-height: 500px;
        overflow-y: auto;
      }
      .login-container {
        max-width: 400px;
        margin: 100px auto;
      }
      .hidden {
        display: none;
      }
      .badge-laki {
        background-color: #007bff;
      }
      .badge-perempuan {
        background-color: #e91e63;
      }
      .search-filter {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Login Section -->
    <div id="loginSection">
      <div class="container">
        <div class="login-container">
          <div class="card shadow">
            <div class="card-header text-center bg-primary text-white">
              <h4><i class="bi bi-person-check"></i> Login Admin TK</h4>
            </div>
            <div class="card-body">
              <form id="loginForm">
                <div class="mb-3">
                  <label for="adminPassword" class="form-label"
                    >Password Admin</label
                  >
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-lock"></i
                    ></span>
                    <input
                      type="password"
                      class="form-control"
                      id="adminPassword"
                      required
                    />
                  </div>
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Masuk Dashboard
                  </button>
                </div>
              </form>
              <div id="loginError" class="alert alert-danger mt-3 hidden">
                Password salah! Silakan coba lagi.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="hidden">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
          <span class="navbar-brand">
            <i class="bi bi-house-heart me-2"></i>Dashboard Admin TK
          </span>
          <div class="navbar-nav ms-auto">
            <button class="btn btn-outline-light btn-sm" id="logoutBtn">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </button>
          </div>
        </div>
      </nav>

      <div class="container-fluid mt-4">
        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card card-stats text-center">
              <div class="card-body">
                <h5 class="card-title text-primary">Total Pendaftaran</h5>
                <h2 id="totalRegistrations" class="text-dark">0</h2>
                <small class="text-muted">Semua data</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-stats text-center">
              <div class="card-body">
                <h5 class="card-title text-success">Bulan Ini</h5>
                <h2 id="monthlyRegistrations" class="text-dark">0</h2>
                <small class="text-muted">Pendaftaran baru</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-stats text-center">
              <div class="card-body">
                <h5 class="card-title text-info">Laki-laki</h5>
                <h2 id="maleCount" class="text-dark">0</h2>
                <small class="text-muted">Siswa</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card card-stats text-center">
              <div class="card-body">
                <h5 class="card-title text-warning">Perempuan</h5>
                <h2 id="femaleCount" class="text-dark">0</h2>
                <small class="text-muted">Siswa</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Search & Filter -->
        <div class="search-filter">
          <div class="row">
            <div class="col-md-4">
              <label class="form-label">Cari Nama</label>
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="bi bi-search"></i
                ></span>
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="Nama anak atau orang tua"
                />
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Filter Gender</label>
              <select class="form-select" id="genderFilter">
                <option value="">Semua Gender</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Filter Bulan</label>
              <select class="form-select" id="monthFilter">
                <option value="">Semua Bulan</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid">
                <button class="btn btn-success" id="exportBtn">
                  <i class="bi bi-download me-1"></i>Export Excel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-table me-2"></i>Data Pendaftaran
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-container">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-dark sticky-top">
                  <tr>
                    <th>No</th>
                    <th>Tanggal</th>
                    <th>Nama Anak</th>
                    <th>Tanggal Lahir</th>
                    <th>Gender</th>
                    <th>Nama Orang Tua</th>
                    <th>Email</th>
                    <th>No. Telepon</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody">
                  <!-- Data akan dimuat di sini -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center mt-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Memuat data...</p>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square me-2"></i>Edit Data Pendaftaran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="editForm">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <h6>Informasi Anak</h6>
                  <div class="mb-3">
                    <label class="form-label">Nama Lengkap Anak</label>
                    <input
                      type="text"
                      class="form-control"
                      id="editChildFullName"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Tanggal Lahir</label>
                    <input
                      type="date"
                      class="form-control"
                      id="editChildDOB"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Jenis Kelamin</label>
                    <select class="form-select" id="editChildGender" required>
                      <option value="">Pilih Jenis Kelamin</option>
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <h6>Informasi Orang Tua</h6>
                  <div class="mb-3">
                    <label class="form-label">Nama Orang Tua</label>
                    <input
                      type="text"
                      class="form-control"
                      id="editParentName"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="editParentEmail"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">No. Telepon</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="editParentPhoneNumber"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Alamat Lengkap</label>
                <textarea
                  class="form-control"
                  id="editAddress"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Informasi Tambahan</label>
                <textarea
                  class="form-control"
                  id="editAdditionalInfo"
                  rows="2"
                ></textarea>
              </div>
              <input type="hidden" id="editRowIndex" />
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>Simpan Perubahan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-lines-fill me-2"></i>Detail Pendaftaran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="modalBody">
            <!-- Detail akan dimuat di sini -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      // Configuration - Ganti dengan URL Apps Script Web App Anda
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwzCegrn_pGgKHVOFu77LCsZuj1xI9Uf2VL2Dk9EcFnBH5I8xM2WApxnOi3szKn1DjcSw/exec";
      const ADMIN_PASSWORD = "admin123";

      let allData = [];
      let filteredData = [];

      document
        .getElementById("loginForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const password = document.getElementById("adminPassword").value;

          if (password === ADMIN_PASSWORD) {
            document.getElementById("loginSection").classList.add("hidden");
            document
              .getElementById("dashboardSection")
              .classList.remove("hidden");
            loadDashboard();
          } else {
            document.getElementById("loginError").classList.remove("hidden");
          }
        });

      document
        .getElementById("logoutBtn")
        .addEventListener("click", function () {
          document.getElementById("dashboardSection").classList.add("hidden");
          document.getElementById("loginSection").classList.remove("hidden");
          document.getElementById("adminPassword").value = "";
          document.getElementById("loginError").classList.add("hidden");
        });

      // Load Dashboard Data
      async function loadDashboard() {
        document.getElementById("loadingIndicator").style.display = "block";

        try {
          // Fetch real data from Apps Script
          const response = await fetch(
            `${APPS_SCRIPT_URL}?action=getData&password=${ADMIN_PASSWORD}`
          );
          const result = await response.json();

          if (result.status === "success") {
            allData = result.data;
            filteredData = [...allData];
          } else {
            console.error("Error loading data:", result.message);
            // Fallback to sample data
            allData = sampleData;
            filteredData = [...allData];
          }
        } catch (error) {
          console.error("Failed to load data:", error);
          // Fallback to sample data untuk demo
          allData = sampleData;
          filteredData = [...allData];
        }

        updateStats();
        populateFilters();
        renderTable();

        document.getElementById("loadingIndicator").style.display = "none";
      }

      // Update Statistics
      function updateStats() {
        const total = allData.length;
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        const monthlyCount = allData.filter((item) => {
          const itemDate = new Date(item.timestamp);
          return (
            itemDate.getMonth() === currentMonth &&
            itemDate.getFullYear() === currentYear
          );
        }).length;

        const maleCount = allData.filter(
          (item) => item.childGender === "Laki-laki"
        ).length;
        const femaleCount = allData.filter(
          (item) => item.childGender === "Perempuan"
        ).length;

        document.getElementById("totalRegistrations").textContent = total;
        document.getElementById("monthlyRegistrations").textContent =
          monthlyCount;
        document.getElementById("maleCount").textContent = maleCount;
        document.getElementById("femaleCount").textContent = femaleCount;
      }

      // Populate Filter Options
      function populateFilters() {
        const monthFilter = document.getElementById("monthFilter");
        const months = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];

        const uniqueMonths = [
          ...new Set(
            allData.map((item) => {
              const date = new Date(item.timestamp);
              return `${date.getFullYear()}-${date.getMonth()}`;
            })
          ),
        ];

        uniqueMonths.forEach((monthKey) => {
          const [year, month] = monthKey.split("-");
          const option = document.createElement("option");
          option.value = monthKey;
          option.textContent = `${months[parseInt(month)]} ${year}`;
          monthFilter.appendChild(option);
        });
      }

      // Render Table
      function renderTable() {
        const tbody = document.getElementById("dataTableBody");
        tbody.innerHTML = "";

        filteredData.forEach((item, index) => {
          const row = document.createElement("tr");
          const date = new Date(item.timestamp);
          const formattedDate = date.toLocaleDateString("id-ID");
          const genderBadge =
            item.childGender === "Laki-laki" ? "badge-laki" : "badge-perempuan";

          row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formattedDate}</td>
                    <td><strong>${item.childFullName}</strong></td>
                    <td>${new Date(item.childDOB).toLocaleDateString(
                      "id-ID"
                    )}</td>
                    <td><span class="badge ${genderBadge}">${
            item.childGender
          }</span></td>
                    <td>${item.parentName}</td>
                    <td>${item.parentEmail}</td>
                    <td>${item.parentPhoneNumber}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="showDetail(${index})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning me-1" onclick="editData(${index})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteData(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // Show Detail Modal
      function showDetail(index) {
        const item = filteredData[index];
        const modalBody = document.getElementById("modalBody");

        modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informasi Anak</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nama Lengkap:</strong></td><td>${
                              item.childFullName
                            }</td></tr>
                            <tr><td><strong>Tanggal Lahir:</strong></td><td>${new Date(
                              item.childDOB
                            ).toLocaleDateString("id-ID")}</td></tr>
                            <tr><td><strong>Jenis Kelamin:</strong></td><td>${
                              item.childGender
                            }</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Informasi Orang Tua</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Nama:</strong></td><td>${
                              item.parentName
                            }</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${
                              item.parentEmail
                            }</td></tr>
                            <tr><td><strong>No. Telepon:</strong></td><td>${
                              item.parentPhoneNumber
                            }</td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Alamat</h6>
                        <p>${item.address}</p>
                        <h6>Informasi Tambahan</h6>
                        <p>${
                          item.additionalInfo || "Tidak ada informasi tambahan"
                        }</p>
                        <h6>Waktu Pendaftaran</h6>
                        <p>${new Date(item.timestamp).toLocaleString(
                          "id-ID"
                        )}</p>
                    </div>
                </div>
            `;

        new bootstrap.Modal(document.getElementById("detailModal")).show();
      }

      // Search and Filter
      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);
      document
        .getElementById("genderFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("monthFilter")
        .addEventListener("change", applyFilters);

      function applyFilters() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const genderFilter = document.getElementById("genderFilter").value;
        const monthFilter = document.getElementById("monthFilter").value;

        filteredData = allData.filter((item) => {
          const matchesSearch =
            searchTerm === "" ||
            item.childFullName.toLowerCase().includes(searchTerm) ||
            item.parentName.toLowerCase().includes(searchTerm);

          const matchesGender =
            genderFilter === "" || item.childGender === genderFilter;

          const matchesMonth =
            monthFilter === "" ||
            (() => {
              const itemDate = new Date(item.timestamp);
              const [year, month] = monthFilter.split("-");
              return (
                itemDate.getFullYear().toString() === year &&
                itemDate.getMonth().toString() === month
              );
            })();

          return matchesSearch && matchesGender && matchesMonth;
        });

        renderTable();
      }

      // Edit Data
      function editData(index) {
        const item = filteredData[index];

        // Populate edit form
        document.getElementById("editChildFullName").value = item.childFullName;
        document.getElementById("editChildDOB").value = item.childDOB;
        document.getElementById("editChildGender").value = item.childGender;
        document.getElementById("editParentName").value = item.parentName;
        document.getElementById("editParentEmail").value = item.parentEmail;
        document.getElementById("editParentPhoneNumber").value =
          item.parentPhoneNumber;
        document.getElementById("editAddress").value = item.address;
        document.getElementById("editAdditionalInfo").value =
          item.additionalInfo || "";
        document.getElementById("editRowIndex").value = item.rowIndex;

        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      // Handle Edit Form Submit
      document
        .getElementById("editForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<i class="bi bi-hourglass-split me-1"></i>Menyimpan...';

          const formData = {
            action: "edit",
            rowIndex: document.getElementById("editRowIndex").value,
            data: {
              childFullName: document.getElementById("editChildFullName").value,
              childDOB: document.getElementById("editChildDOB").value,
              childGender: document.getElementById("editChildGender").value,
              parentName: document.getElementById("editParentName").value,
              parentEmail: document.getElementById("editParentEmail").value,
              parentPhoneNumber: document.getElementById(
                "editParentPhoneNumber"
              ).value,
              address: document.getElementById("editAddress").value,
              additionalInfo:
                document.getElementById("editAdditionalInfo").value,
            },
          };

          try {
            const response = await fetch(APPS_SCRIPT_URL, {
              method: "POST",
              mode: "no-cors",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            // Close modal and refresh data
            bootstrap.Modal.getInstance(
              document.getElementById("editModal")
            ).hide();
            alert("Data berhasil diupdate!");
            loadDashboard();
          } catch (error) {
            console.error("Error updating data:", error);
            alert("Terjadi kesalahan saat mengupdate data");
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

      // Delete Data
      async function deleteData(index) {
        const item = filteredData[index];

        if (
          confirm(
            `Apakah Anda yakin ingin menghapus data pendaftaran ${item.childFullName}?`
          )
        ) {
          try {
            const response = await fetch(
              `${APPS_SCRIPT_URL}?action=deleteRow&rowIndex=${item.rowIndex}&password=${ADMIN_PASSWORD}`
            );
            const result = await response.json();

            if (result.status === "success") {
              alert("Data berhasil dihapus!");
              loadDashboard();
            } else {
              alert("Gagal menghapus data: " + result.message);
            }
          } catch (error) {
            console.error("Error deleting data:", error);
            alert("Terjadi kesalahan saat menghapus data");
          }
        }
      }

      // Export to Excel
      document
        .getElementById("exportBtn")
        .addEventListener("click", async function () {
          try {
            const response = await fetch(
              `${APPS_SCRIPT_URL}?action=exportData&password=${ADMIN_PASSWORD}`
            );
            const csvContent = await response.text();

            // Create download link
            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "data_pendaftaran_tk.csv";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);

            alert("Data berhasil diexport!");
          } catch (error) {
            console.error("Error exporting data:", error);
            alert("Terjadi kesalahan saat mengexport data");
          }
        });
      let inactivityTimer;
      function resetTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          if (
            !document
              .getElementById("dashboardSection")
              .classList.contains("hidden")
          ) {
            alert("Session expired. Silakan login kembali.");
            document.getElementById("logoutBtn").click();
          }
        }, 30 * 60 * 1000); // 30 minutes
      }

      document.addEventListener("mousemove", resetTimer);
      document.addEventListener("keypress", resetTimer);
      document.addEventListener("click", resetTimer);
      document.addEventListener("scroll", resetTimer);
    </script>
  </body>
</html>
